version: "3.7"

services:
  # --- Umbrel App Proxy ---
  app_proxy:
    environment:
      APP_HOST: nextcloud
      APP_PORT: "80"
      PROXY_AUTH_ADD: "false"

  # --- Nextcloud (Official + SMB Hack) ---
  nextcloud:
    image: nextcloud:stable
    restart: unless-stopped
    volumes:
      - ${APP_DATA_DIR}/html:/var/www/html
    entrypoint: 
      - /bin/bash
      - -c
      - |
        apt-get update && \
        apt-get install -y smbclient libsmbclient && \
        exec /entrypoint.sh apache2-foreground
    environment:
      - POSTGRES_HOST=db-nextcloud
      - REDIS_HOST=redis-nextcloud
      - POSTGRES_PASSWORD=umbrel
      - POSTGRES_USER=umbrel
      - POSTGRES_DB=nextcloud
      - NEXTCLOUD_ADMIN_USER=umbrel
      - NEXTCLOUD_ADMIN_PASSWORD=moneyprintergobrrr
      - TRUSTED_PROXIES=172.16.0.0/12 192.168.0.0/16 10.0.0.0/8
      - OVERWRITEPROTOCOL=https
      - NEXTCLOUD_TRUSTED_DOMAINS=*
      - PHP_MEMORY_LIMIT=1024M
      - PHP_UPLOAD_LIMIT=10G
    depends_on:
      db-nextcloud:
        condition: service_healthy
      redis-nextcloud:
        condition: service_healthy
    networks:
      - default

  # --- Database ---
  db-nextcloud:
    image: postgres:16-alpine
    restart: unless-stopped
    volumes:
      - ${APP_DATA_DIR}/pgdata:/var/lib/postgresql/data
    environment:
      - POSTGRES_PASSWORD=umbrel
      - POSTGRES_USER=umbrel
      - POSTGRES_DB=nextcloud
    networks:
      - default
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U umbrel -d nextcloud"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --- Redis ---
  redis-nextcloud:
    image: redis:alpine
    restart: unless-stopped
    volumes:
      - ${APP_DATA_DIR}/redis:/data
    networks:
      - default
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --- Cron ---
  # Крону тоже нужен SMB, чтобы сканировать внешние диски в фоне
  cron:
    image: nextcloud:stable
    restart: unless-stopped
    volumes:
      - ${APP_DATA_DIR}/html:/var/www/html
    # Тот же хак для Cron контейнера
    entrypoint: 
      - /bin/bash
      - -c
      - |
        apt-get update && \
        apt-get install -y smbclient libsmbclient && \
        exec /cron.sh
    depends_on:
      nextcloud:
        condition: service_started
    networks:
      - default

networks:
  default:
    driver: bridge
